**

## 速卖通奇门+聚石塔流程

**  
之前的博客中已经写了如何申请速卖通应用，这篇主要写一下接下来的步骤奇门和聚石塔流程  
这是我在工作中自己总结出来的，写出来希望可以给有需要的人提供一个帮助，1617353983@qq.com是我的邮箱，如果有不懂的可以发邮件给我，我看到之后会回复大家

1. 奇门  
    首先来说下奇门的配置，为了方便配置我统一使用的是字符串格式也就是json  
    ![在这里插入图片描述](https://img-blog.csdnimg.cn/20190705160720106.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21pX2d1X25pYW5n,size_16,color_FFFFFF,t_70)  
    奇门是在控制台–》云工作台–》业务系统架构&集成–》奇门API网关  
    2.创建场景  
    ![在这里插入图片描述](https://img-blog.csdnimg.cn/20190705160923753.png)  
    ![在这里插入图片描述](https://img-blog.csdnimg.cn/20190705160952495.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21pX2d1X25pYW5n,size_16,color_FFFFFF,t_70)  
    场景创建完成之后点击管理，进入之后是创建API  
    ![在这里插入图片描述](https://img-blog.csdnimg.cn/20190705161049571.png)  
    接下来将说道重点奇门配置,以获取单个类目信息为例来说明  
    ![在这里插入图片描述](https://img-blog.csdnimg.cn/20190705161325524.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21pX2d1X25pYW5n,size_16,color_FFFFFF,t_70)  
    **这里的服务地址的ip是聚石塔的公网ip，后面会具体说**  
    ![在这里插入图片描述](https://img-blog.csdnimg.cn/20190705161350631.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21pX2d1X25pYW5n,size_16,color_FFFFFF,t_70)  
    点击下一步  
    ![在这里插入图片描述](https://img-blog.csdnimg.cn/20190705161433687.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21pX2d1X25pYW5n,size_16,color_FFFFFF,t_70)  
    继续点击下一步  
    ![在这里插入图片描述](https://img-blog.csdnimg.cn/20190705161502674.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21pX2d1X25pYW5n,size_16,color_FFFFFF,t_70)  
    **这里的验签demo很重要：验签Demo:{“sub_message”:“Illegal request”,“flag”:“failure”,“sub_code”:“sign-check-failure”}**  
    ![在这里插入图片描述](https://img-blog.csdnimg.cn/2019070516162217.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21pX2d1X25pYW5n,size_16,color_FFFFFF,t_70)  
    这里就是奇门接口自测页面  
    下一步验签需要调用聚石塔中接口，所以先说聚石塔的部署  
    2.聚石塔流程  
    ![在这里插入图片描述](https://img-blog.csdnimg.cn/20190705161828951.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21pX2d1X25pYW5n,size_16,color_FFFFFF,t_70)  
    点击前往新控制台  
    ![在这里插入图片描述](https://img-blog.csdnimg.cn/20190705161902931.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21pX2d1X25pYW5n,size_16,color_FFFFFF,t_70)  
    选择云服务器ECS  
    ![在这里插入图片描述](https://img-blog.csdnimg.cn/20190705161957135.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21pX2d1X25pYW5n,size_16,color_FFFFFF,t_70)  
    点击创建实例，根据需求选择配置付款，付完款之后再实例列表页面就有一条记录  
    此处需要注意的是服务器有公网IP和私网IP，但是付好款之后只有私网IP，但是我们要用的是公网IP  
    ![](https://img-blog.csdnimg.cn/20190705162303302.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21pX2d1X25pYW5n,size_16,color_FFFFFF,t_70)  
    选择弹性公网IP  
    ![在这里插入图片描述](https://img-blog.csdnimg.cn/2019070516240068.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21pX2d1X25pYW5n,size_16,color_FFFFFF,t_70)  
    点击申请弹性公网IP  
    ![在这里插入图片描述](https://img-blog.csdnimg.cn/20190705162436152.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21pX2d1X25pYW5n,size_16,color_FFFFFF,t_70)  
    根据配置选择配置，付款之后在弹性公网IP列表页面会有一条记录  
    下面将聚石塔的实例与弹性公网IP绑定  
    ![在这里插入图片描述](https://img-blog.csdnimg.cn/20190705163003522.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21pX2d1X25pYW5n,size_16,color_FFFFFF,t_70)  
    下面要设置对应端口的开放规则  
    ![在这里插入图片描述](https://img-blog.csdnimg.cn/20190705162727279.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21pX2d1X25pYW5n,size_16,color_FFFFFF,t_70)  
    端口就这些，按照需要设置端口，下面以linux系统80端口为例  
    点击聚石塔这边的控制台  
    ![在这里插入图片描述](https://img-blog.csdnimg.cn/20190705163118195.png)  
    进来之后选择安全组  
    ![在这里插入图片描述](https://img-blog.csdnimg.cn/20190705163213343.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21pX2d1X25pYW5n,size_16,color_FFFFFF,t_70)  
    选择最后一个自定义的安全组管理点击配置规则  
    ![在这里插入图片描述](https://img-blog.csdnimg.cn/20190705163323390.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21pX2d1X25pYW5n,size_16,color_FFFFFF,t_70)  
    选择申请配置规则  
    ![在这里插入图片描述](https://img-blog.csdnimg.cn/20190705163440721.png)  
    我开启的是80端口因此**端口范围那里是80/80,授权对象建议写0.0.0.0/1**  
    ![在这里插入图片描述](https://img-blog.csdnimg.cn/20190705163514278.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21pX2d1X25pYW5n,size_16,color_FFFFFF,t_70)  
    点击确定之后，再次进入安全组页面  
    ![在这里插入图片描述](https://img-blog.csdnimg.cn/20190705163727492.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21pX2d1X25pYW5n,size_16,color_FFFFFF,t_70)  
    选择管理实例，点击添加实例  
    ![在这里插入图片描述](https://img-blog.csdnimg.cn/20190705163804754.png)  
    添加完成后在实例列表页面会有数据  
    聚石塔到这里就部署完成  
    下面**将代码部署到聚石塔中并且运行**  
    为了保证端口已经正确启用，在本地使用telnet 私网ip 80,如果能说明一切正常，如果没有通1.请检查服务器80端口是否开启2,。请检查安全组是否设置正确

下一步奇门接口测试，还是以获取类目为例，我是使用的sdk进行开发的

```
   @RequestMapping("/getPostCategoryById")
    @ResponseBody
    public String getPostCategoryById(String data,String token) {
       AliexpressCategoryRedefiningGetpostcategorybyidRequest request = JSONObject.parseObject(data,new TypeReference<AliexpressCategoryRedefiningGetpostcategorybyidRequest>(){});
        AliexpressCategoryRedefiningGetpostcategorybyidResponse rsp=new AliexpressCategoryRedefiningGetpostcategorybyidResponse();
        try {
            rsp = client.execute(request, token);
            logger.error("返回参数： " + JSONObject.toJSONString(rsp));
        } catch (ApiException e) {
            logger.error("异常原因： " + e.getMessage());
            rsp.setErrorCode("1");
            rsp.setSubMsg(e.getMessage());
        }
        HttpServletRequest httpServletRequest = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();
        CheckResult sign = SignApi.checkSign(httpServletRequest);
        String result=JSONObject.toJSONString(sign);
        logger.error("返回参数： " + result);
        return "{\"data\":"+result+"}";
    }
```

因为奇门配置的返回参数是data,因此外面要包一层data,否则是奇门是拿不到聚石塔返回的数据的  
下一步进行验签，这是上线api必须要的，点击自测通过请求发起服务验证  
![在这里插入图片描述](https://img-blog.csdnimg.cn/20190705164743251.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21pX2d1X25pYW5n,size_16,color_FFFFFF,t_70)  
点击发起验证  
![在这里插入图片描述](https://img-blog.csdnimg.cn/20190705164942704.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21pX2d1X25pYW5n,size_16,color_FFFFFF,t_70)  
上面的代码是调用接口的，验签的时候将调用接口的代码注释到，只留下验签的，需要返回的数据就是奇门配置是的那个验签demo

```
   @RequestMapping("/getPostCategoryById")
    @ResponseBody
    public String getPostCategoryById(String data,String token,HttpServletRequest request) {
        logger.error("传入参数： " + data);
        try {
            CheckResult sign = SpiUtils.checkSign(request, sercrect);
            if(sign.isSuccess()){
                return sign.getRequestBody();
            }else {
              return "{\"sub_message\":\"Illegal request\",\"flag\":\"failure\",\"sub_code\":\"sign-check-failure\"}";
            }
        } catch (IOException e) {
            e.printStackTrace();
            return null;
        }
      /*  AliexpressCategoryRedefiningGetpostcategorybyidRequest request = JSONObject.parseObject(data,new TypeReference<AliexpressCategoryRedefiningGetpostcategorybyidRequest>(){});
        AliexpressCategoryRedefiningGetpostcategorybyidResponse rsp=new AliexpressCategoryRedefiningGetpostcategorybyidResponse();
        try {
            rsp = client.execute(request, token);
            logger.error("返回参数： " + JSONObject.toJSONString(rsp));
        } catch (ApiException e) {
            logger.error("异常原因： " + e.getMessage());
            rsp.setErrorCode("1");
            rsp.setSubMsg(e.getMessage());
        }
        String result=JSONObject.toJSONString(sign);
        logger.error("返回参数： " + result);
        return "{\"data\":"+result+"}";*/
    }
```

验签通过之后可以删掉验签的代码  
验签通过后  
![在这里插入图片描述](https://img-blog.csdnimg.cn/20190705165326149.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21pX2d1X25pYW5n,size_16,color_FFFFFF,t_70)  
![在这里插入图片描述](https://img-blog.csdnimg.cn/20190705165255299.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21pX2d1X25pYW5n,size_16,color_FFFFFF,t_70)  
这样一个接口就上线了，但是每次只要改动了代码就需要重新发布上线  
到这里奇门和聚石塔就已经做完了，下来需要完成调用奇门的步骤  
按照在创建奇门API是的APPKEY对应的应用，来生成sdk,，在新生成的sdk中会有上面创建的奇门API  
![在这里插入图片描述](https://img-blog.csdnimg.cn/20190705165850657.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21pX2d1X25pYW5n,size_16,color_FFFFFF,t_70)  
下来使用这个sdk来调用奇门，还是以获取类目为例

```
  /**
     * 获取单个类目信息
     *
     * @param data 发布类目ID
     */
    public AliexpressCategoryRedefiningGetpostcategorybyidResponse getPostCategoryById(AliexpressCategoryRedefiningGetpostcategorybyidRequest data, AliShop shop) {
        AuthApi.checkToken(shop, "product");//验证token是否有效
        EsellsCategoryRedefiningGetpostcategorybyidRequest reqeust = new EsellsCategoryRedefiningGetpostcategorybyidRequest();//自定义奇门的请求对象
        reqeust.setData(JSONObject.toJSONString(data));
        reqeust.setToken(shop.getAccess_token());
        AliexpressCategoryRedefiningGetpostcategorybyidResponse result=new AliexpressCategoryRedefiningGetpostcategorybyidResponse();
        try {
            EsellsCategoryRedefiningGetpostcategorybyidResponse response = client.execute(reqeust);//调用奇门
            result = JSONObject.parseObject(response.getData(), new TypeReference<AliexpressCategoryRedefiningGetpostcategorybyidResponse>() {
            });
        } catch (ApiException e) {
            result.setErrorCode("1");
            result.setMsg(e.getErrMsg());
        }
        return result;
    }
```

到此整个流程已经接口，在调用奇门这块里有点绕我总结了下，首先是聚石塔内的方法，是接受字符串，返回字符串，调用聚石塔的方法中是将请求对象转成字符串，此处比较绕

整个流程已经全部完成